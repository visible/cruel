---
title: core api
description: the base cruel api for fetch, services, and async functions
---

## quick start

```ts
import { cruel } from "cruel"

const api = cruel(fetch, {
  fail: 0.1,
  delay: [100, 500],
  timeout: 0.05,
})

const res = await api("https://api.example.com")
```

`cruel(fn, options)` injects chaos into async functions.

## chaos options

```ts
type ChaosOptions = {
  fail?: number
  delay?: number | [number, number]
  timeout?: number
  jitter?: number
  spike?: number | [number, number]
  enabled?: boolean
}
```

- `fail`: chance to throw `CruelError`
- `delay`: fixed or random latency
- `timeout`: chance to never resolve
- `jitter`: extra random latency between `0` and `jitter`
- `spike`: occasional added latency
- `enabled`: force-disable on a wrapper

## shortcut wrappers

```ts
cruel.fail(fn, 0.1)
cruel.slow(fn, [100, 500])
cruel.timeout(fn, 0.05)
cruel.flaky(fn)
cruel.unreliable(fn)
cruel.nightmare(fn)
```

## domains

### network

```ts
cruel.network.latency(fn, [100, 500])
cruel.network.packetLoss(fn, 0.1)
cruel.network.disconnect(fn, 0.05)
cruel.network.dns(fn, 0.02)
cruel.network.slow(fn)
cruel.network.unstable(fn)
cruel.network.offline(fn)
```

### http

```ts
cruel.http.status(fn, 500, 0.1)
cruel.http.status(fn, [500, 502, 503])
cruel.http.rateLimit(fn, { rate: 0.1, retryAfter: 60 })
cruel.http.serverError(fn, 0.1)
cruel.http.clientError(fn, 0.1)
cruel.http.badGateway(fn)
cruel.http.serviceUnavailable(fn)
cruel.http.gatewayTimeout(fn)
```

### stream

```ts
cruel.stream.cut(fn, 0.1)
cruel.stream.pause(fn, [200, 1000])
cruel.stream.corrupt(fn, 0.1)
cruel.stream.truncate(fn, 0.1)
cruel.stream.slow(fn)
cruel.stream.flaky(fn)
```

### ai

```ts
cruel.ai.rateLimit(fn, 0.1)
cruel.ai.overloaded(fn, 0.05)
cruel.ai.contextLength(fn, 0.02)
cruel.ai.contentFilter(fn, 0.01)
cruel.ai.modelUnavailable(fn, 0.02)
cruel.ai.slowTokens(fn, [50, 200])
cruel.ai.streamCut(fn, 0.1)
cruel.ai.partialResponse(fn, 0.1)
cruel.ai.invalidJson(fn, 0.05)
cruel.ai.realistic(fn)
cruel.ai.nightmare(fn)
```

## state and control

```ts
cruel.enable({ fail: 0.1, delay: [100, 500] })
cruel.disable()
cruel.toggle()
cruel.isEnabled()

await cruel.scope(async () => {
  await api("https://api.example.com")
}, { fail: 0.2 })
```

## resilience wrappers

```ts
cruel.circuitBreaker(fn, { threshold: 5, timeout: 30000 })
cruel.retry(fn, { attempts: 3, delay: 1000, backoff: "exponential" })
cruel.bulkhead(fn, { maxConcurrent: 10, maxQueue: 100 })
cruel.withTimeout(fn, { ms: 5000 })
cruel.fallback(fn, { fallback: backup })
cruel.hedge(fn, { count: 2, delay: 100 })
cruel.rateLimiter(fn, { requests: 100, interval: 60000 })
cruel.cache(fn, { ttl: 30000 })
cruel.abort(fn, { signal })
```

## composition

```ts
const wrapped = cruel.compose(fetcher, {
  retry: { attempts: 3, delay: 1000, backoff: "exponential" },
  circuitBreaker: { threshold: 5, timeout: 30000 },
  cache: { ttl: 10000 },
  fail: 0.05,
  delay: [100, 300],
})
```

```ts
cruel.wrap(fetcher).fail(0.1)
cruel.wrap(fetcher).slow([100, 500])
cruel.wrap(fetcher).timeout(0.05)
```

## presets and scenarios

```ts
cruel.enable(cruel.presets.development)
cruel.enable(cruel.presets.nightmare)
cruel.enable(cruel.presets.apocalypse)

await cruel.play("networkPartition")
await cruel.play("highLatency")
await cruel.play("degraded")
await cruel.play("recovery")
cruel.stop()
```

## diagnostics

```ts
const off = cruel.on((event) => {
  console.log(event.type, event.target)
})

const stats = cruel.stats()
cruel.resetStats()
off()
```

## fetch interception

```ts
cruel.patchFetch()

cruel.intercept("api.openai.com", {
  rateLimit: { rate: 0.1, retryAfter: 60 },
  delay: [100, 500],
})

cruel.unpatchFetch()
cruel.clearIntercepts()
```

## utilities

```ts
cruel.seed(12345)
cruel.coin(0.5)
cruel.pick([1, 2, 3])
cruel.between(10, 20)
cruel.maybe("value", 0.5)
await cruel.delay([100, 300])
```
